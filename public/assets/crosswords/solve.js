//Key Constants for keyboard controls
function number_cells(){counter=1;var e=$(".cell:not(.void)");$.each(e,function(e,t){number_cell($(t))}),counter=1}function number_cell(e){if(!e.has_above()||!e.has_left())e.set_number(counter),e.attr("data-cell",counter),counter+=1}function cell_highlight(e){e.hasClass("cell")&&!e.hasClass("void")&&(unhighlight_all(),selected=e,e.addClass("selected"),word_highlight())}function highlight_clue_cell(e){var t=$(".cell[data-cell='"+e.attr("clue_num")+"']").first();select_across=e.closest(".clues").attr("id")=="across",cell_highlight(t)}function highlight_next_word(){var e=$(".clue.selected_clue"),t=e.next().first();t.hasClass("clue")?(console.log(solve_app.debug_mode?"next_clue has class clue":""),highlight_clue_cell(t)):highlight_clue_cell(e.parent().parent().siblings(".clue_column").first().children().children().first())}function word_highlight(){$(".selected_word").removeClass("selected_word");var e=$(".selected"),t=select_across?e.get_across_word_cells():e.get_down_word_cells();$.each(t,function(e,t){t.addClass("selected_word")});var n=select_across?e.get_across_start_cell():e.get_down_start_cell();corresponding_clue(n).addClass("selected_clue"),scroll_to_selected()}function unhighlight_all(){selected=null,$(".selected").removeClass("selected"),$(".selected_word").removeClass("selected_word"),$(".selected_clue").removeClass("selected_clue")}function corresponding_clue(e){var t=select_across?".across_clue":".down_clue",n=e.get_number();return $(""+t+"[clue_num="+n+"]")}function scroll_to_selected(){var e=$(".selected_clue"),t=e.closest("ol"),n=t.scrollTop()+e.position().top-t.height()/2+e.height()/2;t.stop().animate({scrollTop:n},"fast")}function selected_word(){var e="";return $.each($(".selected_word"),function(t,n){e+=$(n).get_letter()}),e}function crossword_keypress(e){if(!(e.ctrlKey||e.altKey||e.metaKey)){var t=e.which;switch(t){case UP:selected&&selected.cell_above()&&cell_highlight(selected.cell_above());break;case RIGHT:selected&&selected.cell_to_right()&&cell_highlight(selected.cell_to_right());break;case DOWN:selected&&selected.cell_below()&&cell_highlight(selected.cell_below());break;case LEFT:selected&&selected.cell_to_left()&&cell_highlight(selected.cell_to_left());break;case TAB:unhighlight_all();break;case SHIFT:break;case DELETE:break;case SPACE:select_across=!select_across,cell_highlight($(".selected"));break;default:if(selected){console.log(solve_app.debug_mode?"Typing letter":"");var n=String.fromCharCode(t);n!=selected.get_letter()&&(selected.set_letter(String.fromCharCode(t)),solve_app.update_unsaved()),console.log(solve_app.debug_mode?"highlighting cell":""),cell_highlight(selected.next_empty_cell())}}}}function get_letters(){var e="",t=$(".cell");return $.each(t,function(t,n){e+=$(n).hasClass("void")?"_":$(n).get_letter()}),e}function suppressBackspaceAndNav(e){e=e||window.event;var t=e.target||e.srcElement;if(e.keyCode==BACKSPACE&&!/input|textarea/i.test(t.nodeName))return selected.delete_letter(),solve_app.update_unsaved(),!1;if(_.contains(PAGE_NAV_KEYS,e.keyCode)&&!/input|textarea/i.test(t.nodeName))return!1}var UP=38,RIGHT=39,DOWN=40,LEFT=37,COMMAND=91,ENTER=13,SPACE=32,DELETE=8,SHIFT=16,TAB=9,BACKSPACE=8,PAGE_NAV_KEYS=[UP,RIGHT,DOWN,LEFT,SPACE],selected,select_across=!0,counter=1;$(function(){number_cells(),selected=$(".cell:not(.void)").first(),cell_highlight(selected),$("#crossword").focus(),$(document).on("keydown",crossword_keypress),$("#crossword").on("click","td.cell",function(){cell_highlight($(this))}),$(".clue_column").on("click",".clue",function(){highlight_clue_cell($(this))})}),document.onkeydown=suppressBackspaceAndNav,document.onkeypress=suppressBackspaceAndNav,function(e){e.fn.get_row=function(){return this.data("row")},e.fn.get_col=function(){return this.data("col")},e.fn.in_top_row=function(){return e(this).get_row()==1},e.fn.in_bottom_row=function(){return this.get_row()==e("#crossword").data("rows")},e.fn.in_left_col=function(){return this.get_col()==1},e.fn.in_right_col=function(){return this.get_col()==e("#crossword").data("cols")},e.fn.has_above=function(){if(this.in_top_row())return!1;var t=parseInt(this.get_row()),n=parseInt(this.get_col()),r=e(".cell[data-row='"+(t-1)+"'][data-col='"+n+"']");return!r.hasClass("void")},e.fn.has_below=function(){if(this.in_bottom_row())return!1;var t=parseInt(this.get_row()),n=parseInt(this.get_col()),r=e(".cell[data-row='"+(t+1)+"'][data-col='"+n+"']");return!r.hasClass("void")},e.fn.has_left=function(){if(this.in_left_col())return!1;var t=parseInt(this.get_row()),n=parseInt(this.get_col()),r=e(".cell[data-row='"+t+"'][data-col='"+(n-1)+"']");return!r.hasClass("void")},e.fn.has_right=function(){if(this.in_right_col())return!1;var t=parseInt(this.get_row()),n=parseInt(this.get_col()),r=e(".cell[data-row='"+t+"'][data-col='"+(n+1)+"']");return!r.hasClass("void")},e.fn.cell_to_left=function(){return this.prevAll(".cell:not(.void)").first()},e.fn.cell_to_right=function(){return this.nextAll(".cell:not(.void)").first()},e.fn.cell_above=function(){if(this.in_top_row())return!1;var t=parseInt(this.get_row()),n=parseInt(this.get_col()),r=e(".cell[data-row='"+(t-1)+"'][data-col='"+n+"']");return r.hasClass("void")?r.cell_above():r},e.fn.cell_below=function(){if(this.in_bottom_row())return!1;var t=parseInt(this.get_row()),n=parseInt(this.get_col()),r=e(".cell[data-row='"+(t+1)+"'][data-col='"+n+"']");return r.hasClass("void")?r.cell_below():r},e.fn.next_cell=function(){return select_across?this.cell_to_right():this.cell_below()},e.fn.get_down_word_cells=function(){return this.get_down_start_cell().down_word_from_start()},e.fn.get_down_start_cell=function(){return this.has_above()?this.cell_above().get_down_start_cell():this},e.fn.down_word_from_start=function(){return this.has_below()?[this].concat(this.cell_below().down_word_from_start()):[this]},e.fn.get_down_word=function(){return e.map(this.get_down_word_cells(),function(e,t){return e.text()}).join("")},e.fn.get_across_word_cells=function(){return this.get_across_start_cell().across_word_from_start()},e.fn.get_across_start_cell=function(){return this.has_left()?this.cell_to_left().get_across_start_cell():this},e.fn.across_word_from_start=function(){return this.has_right()?[this].concat(this.cell_to_right().across_word_from_start()):[this]},e.fn.get_across_word=function(){return e.map(this.get_across_word_cells(),function(e,t){return e.text()}).join("")},e.fn.get_letter=function(){var e=this.children(".letter").first().text();return e.length>0?e:" "},e.fn.set_letter=function(e){this.children(".letter").first().text(e)},e.fn.delete_letter=function(e){this.children(".letter").first().empty()},e.fn.get_number=function(){var e=this.children(".cell_num").text();return e.length>0?e:" "},e.fn.set_number=function(e){this.children(".cell_num").text(e)},e.fn.is_last_letter=function(){var e=select_across?this.get_across_word_cells():this.get_down_word_cells(),t=e.length-1;return this[0]==e[t][0]},e.fn.is_empty_cell=function(){return this.get_letter()==""||this.get_letter()==" "},e.fn.next_empty_cell=function(){if(!this.is_last_letter()){var t=this.next_cell();return t.is_empty_cell()?t:t.next_empty_cell()}console.log(selected);if(this.is_empty_cell())return console.log(solve_app.debug_mode?"Is empty cell":""),this;console.log(solve_app.debug_mode?"highlighting next word":""),highlight_next_word();if(e(".selected").get_number()!=1)return e(".selected").is_empty_cell()?e(".selected"):e(".selected").next_empty_cell()}}(jQuery),function(){window.solve_app={solution_id:null,save_timer:null,clock_updater:null,last_save:null,unsaved_changes:!1,debug_mode:!1,ready:function(){return solve_app.save_timer=window.setInterval(function(){if(solve_app.unsaved_changes)return solve_app.save_solution()},5e3),solve_app.clock_updater=window.setInterval(solve_app.update_clock,1e4),$("#show_incorrect").on("click",solve_app.show_incorrect),$("#check_correctness").on("click",solve_app.check_correctness),$("#submit_solution").on("click",solve_app.submit_solution)},save_solution:function(){var e,t,n;return solve_app.debug_mode&&console.log("Saved"),n=$("#crossword").data("auth-token"),e=get_letters(),t={dataType:"script",type:"PUT",url:"/solutions/"+solve_app.solution_id,data:{authenticity_token:n,letters:e}},$.ajax(t)},log_save:function(){return solve_app.last_save=moment().format("dddd, MMMM Do YYYY, h:mm:ss a"),solve_app.unsaved_changes=!1},update_clock:function(){if(solve_app.last_save)return solve_app.debug_mode&&console.log("Updated clock text"),$("#save_status").text("Saved "),$("#save_clock").text(moment(solve_app.last_save).fromNow())},update_unsaved:function(){return solve_app.unsaved_changes=!0,$("#save_status").text("Unsaved changes"),$("#save_clock").empty()},show_incorrect:function(e){var t,n;return e.preventDefault(),solve_app.debug_mode&&console.log("showing incorrect..."),solve_app.save_solution(),t=get_letters(),n={dataType:"script",type:"POST",url:"/solutions/"+solve_app.solution_id+"/get_incorrect",data:{letters:t}},$.ajax(n)},check_correctness:function(e){var t,n;return e.preventDefault(),solve_app.debug_mode&&console.log("checking correctness..."),solve_app.save_solution(),t=get_letters(),n={dataType:"script",type:"POST",url:"/solutions/"+solve_app.solution_id+"/check_correctness",data:{letters:t}},$.ajax(n)}},$(document).ready(solve_app.ready)}.call(this);
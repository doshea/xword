window.team_app =
  solver_red: (Math.random()*266).floor()
  solver_green: (Math.random()*266).floor()
  solver_blue: (Math.random()*266).floor()
  last_audio: null
  myAudio: new Audio('<%= audio_path('chuck.mp3') %>')
  display_name: team_app.display_name
  solver_id: team_app.solver_id

  receive_team_cell: (data)->
    unless team_app.solver_id is data.solver_id
      $cell = $(".cell[data-row=#{data.row}][data-col=#{data.col}]")
      now = Date.now()
      unless (team_app.last_audio and (now-team_app.last_audio < 4000))
        team_app.last_audio = now
        team_app.myAudio.play()
      $cell.children('.cell-flag').stop().css('background', "rgb(#{data.red}, #{data.green}, #{data.blue})").animate({opacity: 1}, 300).delay(300).animate({opacity: 0}, 200);
      if data.letter is ''
        $cell.delete_letter(false)
        solve_app.update_unsaved()
      else
        $cell.set_letter(data.letter, false)
        solve_app.update_unsaved()


  send_team_cell: ($cell, letter) ->
    token = $('#crossword').data('auth-token')
    settings =
      type: 'PATCH'
      url: "/solutions/#{solve_app.solution_id}/team_update"
      data: {authenticity_token: token, letter: letter, col: $cell.data('col'), row: $cell.data('row'), channel: channel, solver_id: team_app.solver_id, red: team_app.solver_red, green: team_app.solver_green, blue: team_app.solver_blue}
    $.ajax(settings)

  join_team: ->
    token = $('#crossword').data('auth-token')
    settings =
      type: 'POST'
      url: "/solutions/#{solve_app.solution_id}/join_team"
      data: {authenticity_token: token, channel: channel, display_name: team_app.display_name, red: team_app.solver_red, green: team_app.solver_green, blue: team_app.solver_blue, solver_id: team_app.solver_id}
    $.ajax(settings)

  leave_team: ->
    token = $('#crossword').data('auth-token')
    settings =
      type: 'POST'
      url: "/solutions/#{solve_app.solution_id}/leave_team"
      data: {authenticity_token: token, channel: channel, solver_id: team_app.solver_id}
    $.ajax(settings)

  welcome_teammate: (data) ->
    unless $(".teammate-box[solver_id=#{data.solver_id}]").length > 0
      teammate = $('<div>')
      teammate.addClass('teammate-box has-tip').css('background',  "rgb(#{data.red}, #{data.green}, #{data.blue})").attr('data-tooltip', true).attr('title', data.display_name).attr('solver_id', data.solver_id)
      $('#teammates').append(teammate)

  farewell_teammate: (data) ->
    console.log('So long, farewell')
    $("#teammates .teammate-box[solver_id=#{data.solver_id}]").fadeOut 1000, ->
      $(this).remove()

  roll_call: ->
    token = $('#crossword').data('auth-token')
    settings =
      type: 'POST'
      url: "/solutions/#{solve_app.solution_id}/roll_call"
      data: {authenticity_token: token, channel: channel}
    $.ajax(settings)

  toggle_chat: ->
    $('#team-chat').toggleClass('down')
    $('#chat-minmax').toggleClass('fi-minus fi-plus')

  receive_chat: (data) ->
    is_my_chat = (team_app.display_name is data['display_name'])
    chats_already_exist = ($('.chat').length > 0)

    chats = $('#team-chat')
    new_chat = $('<div>')
    new_chat.addClass('chat')
    new_chat.addClass('my-chat') if is_my_chat

    avatar = $('<img>')
    display_name = $('<span>') unless is_my_chat
    chat_text = $('<span>')

    avatar.attr('src', data['avatar']).addClass('avatar')
    display_name.text(data['display_name']+': ').addClass('display-name') unless is_my_chat
    chat_text.text(data['chat_text']).addClass('chat-text')

    avatar.appendTo(new_chat)
    unless is_my_chat
      display_name.appendTo(new_chat)
    if is_my_chat then chat_text.prependTo(new_chat) else chat_text.appendTo(new_chat)
    if chats_already_exist then $('<hr />').appendTo($('#chats'))
    new_chat.appendTo($('#chats'))
    $('#chats').stop().animate({scrollTop: $('#chats').height()}, 'medium')

  show_team_clue: ->
    token = $('#crossword').data('auth-token')
    cell_num = $(this).data('cell-num')
    across = $(this).hasClass('across-clue')
    settings =
      type: 'POST'
      url: "/solutions/#{solve_app.solution_id}/show_team_clue/"
      data: {authenticity_token: token, channel: channel, cell_num: cell_num, across: across, red: team_app.solver_red, green: team_app.solver_green, blue: team_app.solver_blue, solver_id: team_app.solver_id}
    $.ajax(settings)

  outline_team_clue: (data) ->
    unless data.solver_id is team_app.solver_id
      outline_width = 2
      outline_id = "#{data.solver_id}_word_highlight"
      outline_color = "#{data.red}, #{data.green}, #{data.blue}"
      the_outline = $("##{outline_id}")
      unless the_outline.get(0)
        the_outline = $("<div id='#{outline_id}'>")
        the_outline.addClass('team-outline').hide().css('border', "#{outline_width}px dashed rgb(#{outline_color})").css('background-color', "rgba(#{outline_color}, 0.2)")
        $('body').append(the_outline)

      across = data['across'] is 'true'
      start_cell = $(".cell[data-cell=#{data.cell_num}]")
      word_cells = if across then start_cell.get_across_word_cells() else start_cell.get_down_word_cells()
      number_of_cells = word_cells.length
      height_of_outline = if across then word_cells[0].height()-3 else word_cells[0].height()*number_of_cells+2*number_of_cells-5
      width_of_outline = if across then word_cells[0].width()*number_of_cells+2*number_of_cells-5 else word_cells[0].width()-3
      left_corner_x = word_cells[0].offset().left+1
      left_corner_y = word_cells[0].offset().top+1
      the_outline.height(height_of_outline)
      the_outline.width(width_of_outline)
      the_outline.offset({ top: left_corner_y, left: left_corner_x })
      the_outline.show()

$ ->
  $('#myModal').foundation('reveal', 'open');
  listening_channel = pusher.subscribe(channel)
  listening_channel.bind('change_cell', team_app.receive_team_cell)
  listening_channel.bind('join_puzzle', team_app.welcome_teammate)
  listening_channel.bind('leave_puzzle', team_app.farewell_teammate)
  listening_channel.bind('roll_call', team_app.join_team)
  listening_channel.bind('chat_message', team_app.receive_chat)
  listening_channel.bind('outline_team_clue', team_app.outline_team_clue)
  team_app.roll_call()
  $('#team-chat .row-topper').on('click', team_app.toggle_chat)
  $('.clue').on('click', team_app.show_team_clue)

  $(window).on('unload', team_app.leave_team)


